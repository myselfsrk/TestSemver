pipeline {
    agent any

    parameters {
        choice(name: 'BUMP_TYPE', choices: ['patch', 'major', 'minor'], description: 'Which version bump do you want to perform?')
    }
    environment {
        NEW_VERSION = ''
    }
    stages {
        stage('Major') {
            when {
                expression { params.BUMP_TYPE == 'major' }
            }
            steps {
                script {
                    def currentVersion = readFile('Version').trim()
                    def major = sh(script: "echo ${currentVersion} | cut -d. -f1", returnStdout: true).trim()
                    major = "${major.toInteger() + 1}"
                    env.NEW_VERSION = "${major}.0.0"
                    writeFile(file: 'Version', text: env.NEW_VERSION)
                    echo "Bumped patch version to ${env.NEW_VERSION}"
                }
            }
        }

        stage('Minor') {
            when {
                expression { params.BUMP_TYPE == 'minor' }
            }
            steps {
                script {
                    def currentVersion = readFile('Version').trim()
                    def major = sh(script: "echo ${currentVersion} | cut -d. -f1", returnStdout: true).trim()
                    def minor = sh(script: "echo ${currentVersion} | cut -d. -f2", returnStdout: true).trim()
                    minor = "${minor.toInteger() + 1}"
                    env.NEW_VERSION = "${major}.${minor}.0"
                    writeFile(file: 'Version', text: env.NEW_VERSION)
                    echo "Bumped patch version to ${env.NEW_VERSION}"
                }
            }
        }

        stage('Patch') {
            when {
                expression { params.BUMP_TYPE == 'patch' || !params.BUMP_TYPE }
            }
            steps {
                script {
                    def currentVersion = readFile('Version').trim()
                    def major = sh(script: "echo ${currentVersion} | cut -d. -f1", returnStdout: true).trim()
                    def minor = sh(script: "echo ${currentVersion} | cut -d. -f2", returnStdout: true).trim()
                    def patch = sh(script: "echo ${currentVersion} | cut -d. -f3", returnStdout: true).trim()
                    patch = "${patch.toInteger() + 1}"
                    env.NEW_VERSION = "${major}.${minor}.${patch}"
                    writeFile(file: 'Version', text: env.NEW_VERSION)
                    echo "Bumped patch version to ${env.NEW_VERSION}"
                }
            }
        }
    }
}
